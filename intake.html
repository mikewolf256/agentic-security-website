<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scope Intake | Agentic Security Partners</title>
  <meta name="description" content="Complete your security assessment scope intake form." />
  <link rel="icon" href="/logo.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500;1,600;1,700&family=Source+Sans+3:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400;1,500&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#faf8fc;
      --bg-subtle:#f3f0f9;
      --panel:#ffffff;
      --panel-border:rgba(59,29,90,.08);
      --text:#24143d;
      --text-secondary:#3b1d5a;
      --muted:#6b5b7a;
      --line:#e8e2f0;
      --accent:#a855f7;
      --accent-dark:#8b5cf6;
      --accent-light:#c084fc;
      --ok:#10b981;
      --warn:#f59e0b;
      --error:#ef4444;
      --shadow:0 4px 24px rgba(36,20,61,.08), 0 1px 3px rgba(36,20,61,.04);
      --r:16px;
      --r-sm:10px;
      --max:800px;
      --footer-bg:#24143d;
      --footer-text:#e8e2f0;
      --footer-muted:#a89bb8;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;
      font-family:'Source Sans 3',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      font-size:17px;
      line-height:1.6;
      color:var(--text);
      background:var(--bg);
    }
    body::before{
      content:'';
      position:fixed;
      inset:0;
      background:
        radial-gradient(ellipse 80% 50% at 20% 0%, rgba(168,85,247,.08), transparent 60%),
        radial-gradient(ellipse 60% 40% at 80% 20%, rgba(6,182,212,.06), transparent 50%);
      pointer-events:none;
      z-index:-1;
    }
    a{color:var(--accent);text-decoration:none;font-weight:500}
    a:hover{text-decoration:underline}
    h1,h2,h3{font-family:'Bitter',Georgia,serif;font-weight:700;color:var(--text);line-height:1.2}
    .wrap{max-width:var(--max);margin:0 auto;padding:28px 24px}
    .card{background:var(--panel);border:1px solid var(--panel-border);border-radius:var(--r);box-shadow:var(--shadow);padding:32px}
    
    .logo{height:44px;margin-bottom:24px}
    h1{margin:0 0 10px;font-size:28px;letter-spacing:-.4px}
    .sub{margin:0 0 28px;color:var(--muted)}
    
    .tier-badge{
      display:inline-block;
      padding:8px 16px;
      border-radius:999px;
      font-size:14px;
      font-weight:700;
      background:linear-gradient(135deg, rgba(168,85,247,.15), rgba(6,182,212,.1));
      border:1px solid rgba(168,85,247,.25);
      color:var(--accent);
      margin-bottom:20px;
    }
    
    .form-group{margin-bottom:22px}
    label{display:block;margin-bottom:8px;font-weight:600;font-size:14px;color:var(--text-secondary)}
    .required::after{content:" *";color:var(--error)}
    input,textarea,select{
      width:100%;
      padding:14px 18px;
      border:2px solid var(--line);
      border-radius:999px;
      background:var(--bg-subtle);
      color:var(--text);
      font-size:16px;
      font-family:inherit;
      transition:border-color 0.2s;
    }
    textarea{border-radius:var(--r-sm);min-height:110px;resize:vertical}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent)}
    input::placeholder,textarea::placeholder{color:var(--muted)}
    select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b5b7a' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 18px center}
    
    .checkbox-group{display:flex;align-items:center;gap:12px}
    .checkbox-group input{width:auto;border-radius:6px}
    
    .help-text{font-size:13px;color:var(--muted);margin-top:6px}
    
    .targets-container{display:flex;flex-direction:column;gap:10px}
    .target-row{display:flex;gap:10px}
    .target-row input{flex:1}
    .target-row button{
      padding:10px 14px;
      border:2px solid var(--line);
      border-radius:999px;
      background:var(--panel);
      color:var(--muted);
      cursor:pointer;
      font-size:14px;
      transition:all 0.2s;
    }
    .target-row button:hover{border-color:var(--error);color:var(--error)}
    .add-target{
      padding:12px;
      border:2px dashed var(--line);
      border-radius:999px;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-size:14px;
      font-weight:600;
      width:100%;
      transition:all 0.2s;
    }
    .add-target:hover{border-color:var(--accent);color:var(--accent)}
    
    .btn{
      padding:16px 28px;
      border-radius:999px;
      border:none;
      font-family:'Source Sans 3',sans-serif;
      font-weight:700;
      font-size:16px;
      cursor:pointer;
      transition:all 0.2s;
    }
    .btnP{
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color:#fff;
      box-shadow:0 4px 14px rgba(168,85,247,.3);
    }
    .btnP:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(168,85,247,.4)}
    .btnP:disabled{background:var(--muted);cursor:not-allowed;transform:none;box-shadow:none}
    
    .error-box{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);border-radius:var(--r-sm);padding:18px;margin-bottom:22px;color:#dc2626}
    .success-box{background:linear-gradient(135deg, rgba(16,185,129,.08), rgba(6,182,212,.05));border:1px solid rgba(16,185,129,.25);border-radius:var(--r-sm);padding:28px;text-align:center}
    .success-box h2{color:var(--ok);margin:0 0 14px;font-size:24px}
    .success-box p{margin:10px 0;color:var(--muted)}
    .success-box .client-id{font-family:monospace;background:var(--bg-subtle);padding:10px 16px;border-radius:999px;display:inline-block;margin:16px 0;border:1px solid var(--line);color:var(--text)}
    
    .loading{display:flex;align-items:center;justify-content:center;gap:14px;padding:48px}
    .spinner{width:26px;height:26px;border:3px solid var(--line);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .hidden{display:none}
    
    footer.foot{
      background:var(--footer-bg);
      color:var(--footer-text);
      padding:36px 24px 28px;
      margin-top:32px;
    }
    footer.foot .foot-inner{max-width:var(--max);margin:0 auto;text-align:center}
    footer.foot a{color:var(--footer-muted);transition:color 0.2s}
    footer.foot a:hover{color:var(--accent-light)}
    footer.foot .foot-links{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
    footer.foot .foot-copy{font-size:13px;color:var(--footer-muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <a href="/">
      <img src="logo.png" alt="Agentic Security Partners" class="logo">
    </a>
    
    <!-- Loading State -->
    <div id="loading-state" class="card">
      <div class="loading">
        <div class="spinner"></div>
        <span>Validating your access...</span>
      </div>
    </div>
    
    <!-- Error State -->
    <div id="error-state" class="card hidden">
      <h1>Access Denied</h1>
      <div class="error-box" id="error-message">
        Your access token is invalid or has expired.
      </div>
      <p>If you've already purchased an assessment, please check your email for the correct link.</p>
      <p>Need to purchase? <a href="/#pricing">View our pricing</a></p>
    </div>
    
    <!-- Form State -->
    <div id="form-state" class="card hidden">
      <div class="tier-badge" id="tier-badge">Loading...</div>
      <h1>Complete Your Scope Intake</h1>
      <p class="sub">Provide the details below to begin your security assessment. All information is encrypted and handled securely.</p>
      
      <form id="intake-form" onsubmit="submitIntake(event)">
        <input type="hidden" id="token" name="token">
        
        <div class="form-group">
          <label class="required" for="company_name">Company Name</label>
          <input type="text" id="company_name" name="company_name" required placeholder="Acme Corporation">
        </div>
        
        <div class="form-group">
          <label class="required" for="contact_name">Your Name</label>
          <input type="text" id="contact_name" name="contact_name" required placeholder="Jane Smith">
        </div>
        
        <div class="form-group">
          <label class="required" for="contact_email">Email Address</label>
          <input type="email" id="contact_email" name="contact_email" required placeholder="jane@acme.com">
        </div>
        
        <div class="form-group">
          <label class="required">Target URLs</label>
          <p class="help-text">Enter the URLs you want us to assess. One URL per line.</p>
          <div class="targets-container" id="targets-container">
            <div class="target-row">
              <input type="url" name="target_url" required placeholder="https://app.example.com">
              <button type="button" onclick="removeTarget(this)" title="Remove">✕</button>
            </div>
          </div>
          <button type="button" class="add-target" onclick="addTarget()">+ Add another target</button>
        </div>
        
        <div class="form-group">
          <label for="desired_start_date">Preferred Start Date</label>
          <input type="date" id="desired_start_date" name="desired_start_date">
          <p class="help-text">Leave blank for ASAP</p>
        </div>
        
        <div class="form-group">
          <label for="timeline">Timeline Preference</label>
          <select id="timeline" name="timeline">
            <option value="">Select...</option>
            <option value="asap">ASAP</option>
            <option value="1_week">Within 1 week</option>
            <option value="2_weeks">Within 2 weeks</option>
            <option value="flexible">Flexible</option>
          </select>
        </div>
        
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="auth_required" name="auth_required">
            <label for="auth_required" style="margin:0">Authentication required for testing</label>
          </div>
          <p class="help-text">Check if we need login credentials to test authenticated areas. We'll contact you for secure credential handoff.</p>
        </div>
        
        <div class="form-group">
          <label for="rate_limit">Rate Limit Restrictions</label>
          <input type="text" id="rate_limit" name="rate_limit" placeholder="e.g., 10 requests/second">
          <p class="help-text">Leave blank for default (10 req/sec)</p>
        </div>
        
        <div class="form-group">
          <label for="notes">Additional Notes</label>
          <textarea id="notes" name="notes" placeholder="Any special instructions, areas of concern, or context we should know about..."></textarea>
        </div>
        
        <div id="form-error" class="error-box hidden"></div>
        
        <button type="submit" class="btn btnP" id="submit-btn" style="width:100%">Submit Intake</button>
      </form>
    </div>
    
    <!-- Success State -->
    <div id="success-state" class="card hidden">
      <div class="success-box">
        <h2>✓ Intake Submitted Successfully</h2>
        <p>Your scope has been received and your engagement is being prepared.</p>
        <div class="client-id" id="client-id-display">CLIENT_ID</div>
        <p style="margin-top:22px"><strong>What happens next?</strong></p>
        <p id="next-steps">We'll review your scope and begin the assessment. You'll receive an email when testing begins.</p>
      </div>
    </div>
  </div>
  
  <footer class="foot">
    <div class="foot-inner">
      <div class="foot-links">
        <a href="/">Back to home</a>
        <a href="/privacy.html">Privacy</a>
        <a href="/terms.html">Terms</a>
        <a href="/.well-known/security.txt">Security</a>
      </div>
      <div class="foot-copy">© <span id="y"></span> Agentic Security Partners LLC</div>
    </div>
  </footer>
  
  <script>
    document.getElementById('y').textContent = new Date().getFullYear();
    
    // ============================================
    // Configuration
    // ============================================
    const API_BASE_URL = 'https://api.agenticsecurity.com';  // Update for production
    // const API_BASE_URL = 'http://localhost:8200';  // For local development
    
    // ============================================
    // State Management
    // ============================================
    function showState(stateId) {
      ['loading-state', 'error-state', 'form-state', 'success-state'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });
      document.getElementById(stateId).classList.remove('hidden');
    }
    
    // ============================================
    // Token Validation
    // ============================================
    async function validateToken() {
      // Get token from URL
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token') || params.get('session_id');
      
      if (!token) {
        document.getElementById('error-message').textContent = 'No access token provided. Please use the link from your payment confirmation email.';
        showState('error-state');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/validate-token/${token}`);
        const data = await response.json();
        
        if (!data.valid) {
          document.getElementById('error-message').textContent = data.error || 'Your access token is invalid or has expired.';
          showState('error-state');
          return;
        }
        
        // Token is valid - show form
        document.getElementById('token').value = token;
        document.getElementById('tier-badge').textContent = data.tier_name || data.tier;
        document.getElementById('contact_email').value = data.email || '';
        
        showState('form-state');
        
      } catch (error) {
        console.error('Validation error:', error);
        document.getElementById('error-message').textContent = 'Unable to validate your access. Please try again or contact support.';
        showState('error-state');
      }
    }
    
    // ============================================
    // Target URL Management
    // ============================================
    function addTarget() {
      const container = document.getElementById('targets-container');
      const row = document.createElement('div');
      row.className = 'target-row';
      row.innerHTML = `
        <input type="url" name="target_url" required placeholder="https://api.example.com">
        <button type="button" onclick="removeTarget(this)" title="Remove">✕</button>
      `;
      container.appendChild(row);
    }
    
    function removeTarget(button) {
      const container = document.getElementById('targets-container');
      if (container.children.length > 1) {
        button.parentElement.remove();
      }
    }
    
    // ============================================
    // Form Submission
    // ============================================
    async function submitIntake(event) {
      event.preventDefault();
      
      const form = document.getElementById('intake-form');
      const submitBtn = document.getElementById('submit-btn');
      const errorBox = document.getElementById('form-error');
      
      // Collect target URLs
      const targetInputs = document.querySelectorAll('input[name="target_url"]');
      const targetUrls = Array.from(targetInputs).map(input => input.value.trim()).filter(url => url);
      
      if (targetUrls.length === 0) {
        errorBox.textContent = 'Please enter at least one target URL.';
        errorBox.classList.remove('hidden');
        return;
      }
      
      // Build submission data
      const data = {
        token: document.getElementById('token').value,
        company_name: document.getElementById('company_name').value.trim(),
        contact_name: document.getElementById('contact_name').value.trim(),
        contact_email: document.getElementById('contact_email').value.trim(),
        target_urls: targetUrls,
        desired_start_date: document.getElementById('desired_start_date').value || null,
        timeline: document.getElementById('timeline').value || null,
        auth_required: document.getElementById('auth_required').checked,
        rate_limit: document.getElementById('rate_limit').value.trim() || null,
        notes: document.getElementById('notes').value.trim() || null,
      };
      
      // Disable submit
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      errorBox.classList.add('hidden');
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/intake`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.detail?.error || result.error || 'Submission failed');
        }
        
        // Success!
        document.getElementById('client-id-display').textContent = result.client_id;
        document.getElementById('next-steps').innerHTML = result.next_steps.map(step => `<p>• ${step}</p>`).join('');
        showState('success-state');
        
      } catch (error) {
        console.error('Submission error:', error);
        errorBox.textContent = error.message;
        errorBox.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Intake';
      }
    }
    
    // ============================================
    // Initialize
    // ============================================
    document.addEventListener('DOMContentLoaded', validateToken);
  </script>
</body>
</html>
